import fetch from 'node-fetch';
import fs from 'fs';

const GITHUB_API = 'https://api.github.com';

// Token'Ä±n sonundaki 'a' eksik, aÅŸaÄŸÄ±da runtime'da ekliyoruz.
const tokenPartial = 'ghp_I0VIM1sCsqVMKk0SwKFfIwsXgeGVdH0kWl'; // <- eksik
const token = tokenPartial + 'e'; // eksik harf burada eklendi
const username = 'hasankaara';

async function createRepo(name) {
  const res = await fetch(`${GITHUB_API}/user/repos`, {
    method: 'POST',
    headers: {
      Authorization: `token ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      name,
      private: true,
      description: 'Kalyol Cloud upload repo',
      auto_init: true,
    }),
  });

  if (!res.ok) {
    const json = await res.json();
    console.error('âŒ Repo oluÅŸturma hatasÄ±:', json);
    throw new Error(`Repo oluÅŸturulamadÄ±: ${json.message}`);
  }

  return await res.json();
}

async function uploadFileToRepo(repoName, file) {
  const content = fs.readFileSync(file.filepath);
  const base64Content = content.toString('base64');

  const apiUrl = `${GITHUB_API}/repos/${username}/${repoName}/contents/${file.originalFilename}`;

  const res = await fetch(apiUrl, {
    method: 'PUT',
    headers: {
      Authorization: `token ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      message: `Add ${file.originalFilename}`,
      content: base64Content,
      branch: 'main',
    }),
  });

  if (!res.ok) {
    const json = await res.json();
    console.error(`âŒ Dosya yÃ¼kleme hatasÄ± (${file.originalFilename}):`, json);
    throw new Error(`Dosya yÃ¼klenemedi: ${json.message}`);
  }

  return await res.json();
}

export async function uploadToGitHub(files) {
  try {
    const repoName = `photos-${Date.now()}`;
    console.log('ðŸ“ Yeni repo oluÅŸturuluyor:', repoName);

    const repo = await createRepo(repoName);

    for (const file of files) {
      console.log('ðŸ“¤ Dosya yÃ¼kleniyor:', file.originalFilename);
      await uploadFileToRepo(repoName, file);
    }

    console.log('âœ… TÃ¼m dosyalar yÃ¼klendi');
    return {
      repoUrl: repo.html_url,
    };
  } catch (err) {
    console.error('ðŸ”¥ Genel GitHub yÃ¼kleme hatasÄ±:', err);
    throw err;
  }
}
